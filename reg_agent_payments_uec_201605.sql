/*
--reestr of refillments april 2016
--'3801;3812155469;044583722;'  UEC IO
--'3802;3801111847;042520607;' Socsystema
select 'ORGANIZATIONID;INN;BIC;MIFAREUID;TRANSPORTCARDID;TICKETID;AMOUNT' from dual;
--REGISTERAGENTPAYMENTS 
  --SELECT '3801;3812155469;044583722;'||SUBSTR(T.CARD_CHIP,1,8)||';9643103883'||SUBSTR(T.CARD_NUM,2)||';'||LPAD(T.CARD_SERIES,4,'0')||';15000'
  SELECT '3802;3801111847;042520607;'||SUBSTR(T.CARD_CHIP,1,8)||';9643103883'||SUBSTR(T.CARD_NUM,2)||';'||LPAD(T.CARD_SERIES,4,'0')||';15000'
 FROM CPTT.T_DATA T
-- INNER JOIN CPTT.CARD C ON T.ID_CARD=C.ID
 INNER JOIN CPTT.DIVISION D ON T.ID_DIVISION=D.ID
 INNER JOIN CPTT.OPERATOR O ON D.ID_OPERATOR=O.ID  and O.ROLE=2
 --INNER JOIN CPTT.REF_JPERSON J ON O.ID_JPERSON=J.ID
 --INNER JOIN CPTT.REF_BANK B ON J.ID_BANK_ACCOUNT=B.ID
 WHERE
T.CARD_SERIES in (83) --Серии карт
 and O.CODE =10
AND   T.KIND in (7,12)
AND T.DATE_TO=TO_DATE('31.05.2016 00:00:00','DD.MM.YYYY HH24:MI:SS')
--exclude not used card
AND T.CARD_NUM  not in (
'0003010071',
'0003000655',
'0003000233',
'0003006529',
'0003014553',
'0003004809',
'0003009239',
'0003018161',
'0003006177',
'0003021574',
'0003000854',
'0003023474',
'0003019219', 
'0003004382',
'0003020020',
'0003024038',
'0003022284',
'0003001452',
'0003002238',
'0003012649',
'0003016518',
'0003015115',
'0003002266',
'0003003108',
'0003007229',
'0003022364',
'0003010927',
'0003007143',
'0003007884',
'0003004020',
'0003005908',
'0003001204',
'0003007288',
'0003024217',
'0003021148',
'0003012213',
'0003006366',
'0003002242',
'0003001982',
'0003012085',
'0003004561',
'0003015597',
'0003006923',
'0003004442',
'0003006950',
'0003024447',
'0003023142',
'0003008675',
'0003003684',
'0003024450',
'0003019891',
'0003015547',
'0003020216',
'0003006800',
'0003001599',
'0003024216',
'0003013208',
'0003006413',
'0003005582',
'0003015540',
'0003002926',
'0003024335',
'0003005078',
'0003009504',
'0003017922',
'0003005003',
'0003013272',
'0003023203',
'0003001203',
'0003019224',
'0003001873',
'0003024321',
'0003012487',
'0003001429',
'0003011568',
'0003005338',
'0003008702',
'0003022562',
'0003024422',
'0003017683',
'0003008674',
'0003003238',
'0003000351',
'0003006485',
'0003001413',
'0003023051',
'0003024449',
'0003021682',
'0003024093',
'0003021507',
'0003020039',
'0003023879',
'0003016866',
'0003009900',
'0003005713',
'0003013137',
'0003001792',
'0003012395',
'0003004298',
'0003002022',
'0003015593',
'0003000823',
'0003019230',
'0003001632',
'0003008543',
'0003023786',
'0003024923',
'0003017264',
'0003025112',
'0003000368',
'0003006748',
'0003009958',
'0003017771',
'0003003333',
'0003021348',
'0003005074',
'0003022398',
'0003017266',
'0003006539',
'0003005209',
'0003023462',
'0003011096',
'0003019572',
'0003025069',
'0003019682',
'0003021520',
'0003015032',
'0003003327',
'0003016436',
'0003013113',
'0003015709',
'0003012356',
'0003009115',
'0003003789',
'0003007129',
'0003024656',
'0003011766',
'0003013727',
'0003015475',
'0003002614',
'0003025740',
'0003011432',
'0003024437',
'0003020248',
'0003011267',
'0003007105',
'0003021156',
'0003005286',
'0003000789',
'0003024643',
'0003015731',
'0003012778',
'0003022782',
'0003003569',
'0003009094',
'0003013748',
'0003011485',
'0003020507',
'0003001633',
'0003010744',
'0003021687',
'0003017261',
'0003024676',
'0003020992',
'0003019243',
'0003017970',
'0003001098',
'0003007098',
'0003021184',
'0003024440',
'0003012036',
'0003002743',
'0003022259',
'0003006303',
'0003009329',
'0003006560',
'0003000995',
'0003006704',
'0003024334',
'0003020942',
'0003009774',
'0003014678',
'0003008541',
'0003017573',
'0003016646',
'0003025881',
'0003016417',
'0003016103',
'0003020895',
'0003025018',
'0003007216',
'0003001330',
'0003019158',
'0003004839',
'0003006097',
'0003013906',
'0003022650',
'0003006015',
'0003020219',
'0003022013',
'0003006603',
'0003002398',
'0003025685',
'0003019190',
'0003023802',
'0003002039',
'0003025205',
'0003024413',
'0003017971',
'0003002101',
'0003000638',
'0003009889',
'0003014308',
'0003023166',
'0003001627',
'0003025009',
'0003022320',
'0003017791',
'0003019247',
'0003016119',
'0003004799',
'0003023198',
'0003016935',
'0003000402',
'0003006794',
'0003007267',
'0003015178',
'0003022824',
'0003017522',
'0003023239',
'0003005122',
'0003021464',
'0003015544',
'0003020545',
'0003007717',
'0003000163',
'0003013636',
'0003015796',
'0003019626',
'0003025789',
'0003021030',
'0003001308',
'0003009948',
'0003021096',
'0003001861',
'0003013688',
'0003001594',
'0003014495',
'0003018059',
'0003005251',
'0003005531',
'0003005292',
'0003025402',
'0003022764',
'0003018696',
'0003014034',
'0003025664',
'0003002423',
'0003024533',
'0003006537',
'0003002197',
'0003023652',
'0003017703',
'0003003077',
'0003000613',
'0003005310',
'0003011440',
'0003007944',
'0003016628',
'0003013114',
'0003025426',
'0003023291',
'0003009219',
'0003005148',
'0003014960',
'0003014266',
'0003006925',
'0003000986'
)

--double refillment
and T.ID not in (
17174051200001000,
17209287200001000,
17209802000001000,
17211177300001000,
17217640000001000,
17217642900001000,
17229117500001000,
17231600800001000,
17238301100001000,
17238302900001000,
17247453800001000,
17249735400001000,
17250309200001000,
17256316000001000,
17258723100001000,
17265808400001000,
17266538000001000,
17267647400001000,
17267974300001000,
17268017600001000,
17274766100001000,
17275260400001000,
17286196000001000,
17286262700001000,
17295681800001000,
17295699700001000,
17295724600001000,
17295917200001000,
17304874100001000,
17322930900001000,
17322935800001000,
17323977400001000,
17325912500001000,
17340513900001000,
17356648100001000,
17372196700001000,
17399722800001000,
17445817700001000,
17399723700001000
)


--select 'ORGANIZATIONID;INN;BIC;MIFAREUID;TRANSPORTCARDID;TICKETID;AMOUNT' from dual
--UNION
--
SELECT 
--'3801;3812155469;044583722;'||SUBSTR(MAX(T.CARD_CHIP),1,8)||';964310380'||T.CARD_NUM||';'||LPAD(MAX(T.CARD_SERIES),4,'0')||';15000' as NUM
 --,SUBSTR(MAX(T.CARD_CHIP),1,8) as CHIP1, T.CARD_NUM
--, O.CODE
-- , count (*) as kol_t
--T.*
--T.card_num, T.date_to, T.amount, T.amount_bail, T.amount_discount
T.date_to, count(*) as kol, SUM(T.amount) as s
 FROM CPTT.T_DATA T
    INNER JOIN CPTT.DIVISION D ON T.ID_DIVISION=D.ID
   INNER JOIN CPTT.OPERATOR O ON D.ID_OPERATOR=O.ID  and O.ROLE=2
 WHERE 
     --T.CARD_SERIES  in (60,63) 
     T.CARD_SERIES =83
     --and O.CODE in ('0002','0003','0004','0005','0006','0007','0008','0009','0011','0012','0013','0014','0015','0016','0017','0018','0019','0020','0021','0022','0023','0024','0025','0026','0027','0062')  
     and O.CODE = '0010'
AND   T.KIND  in (7,12)
GROUP by T.DATE_TO
--GROUP BY '964310380'||T.CARD_NUM --, O.CODE
--ORDER BY  '964310380'||T.CARD_NUM --, O.CODE
--GROUP BY T.CARD_NUM --, O.CODE
--ORDER BY T.CARD_NUM --, O.CODE

select T1.card_num, T1.amount, T1.ID, T1.DATE_OF,T1.DATE_TO, T1.INS_DATE, T1.UPD_DATE, T1.CARD_CHIP FROM CPTT.T_DATA T1 where T1.CARD_NUM in (
SELECT 
T.card_num
--, T.amount, O.CODE, O.NAME, T.ID, T.DATE_OF,T.DATE_TO, T.INS_DATE, T.UPD_DATE, T.CARD_CHIP
--, count(*) as kol, SUM(T.amount) as s, MIN(T.ID)
--T.date_to, count(*) as kol, SUM(T.amount) as s
 FROM CPTT.T_DATA T
    INNER JOIN CPTT.DIVISION D ON T.ID_DIVISION=D.ID
    INNER JOIN CPTT.OPERATOR O ON D.ID_OPERATOR=O.ID  and O.ROLE=2
 WHERE 
     --T.CARD_SERIES  in (60,63) 
     T.CARD_SERIES =83
     --and O.CODE in ('0002','0003','0004','0005','0006','0007','0008','0009','0011','0012','0013','0014','0015','0016','0017','0018','0019','0020','0021','0022','0023','0024','0025','0026','0027','0062')  
     and O.CODE='0010'
AND   T.KIND  in (7,8,11,12,13)
AND T.DATE_TO=TO_DATE('31.05.2016 00:00:00','DD.MM.YYYY HH24:MI:SS')
GROUP by T.CARD_NUM
HAVING count(*)>1
)  and T1.KIND  in (7,8,11,12,13)
AND T1.DATE_TO=TO_DATE('31.05.2016 00:00:00','DD.MM.YYYY HH24:MI:SS')
ORDER BY  T1.card_num, T1.DATE_OF


