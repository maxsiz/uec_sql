/*
--reestr of refillments april 2016
--'3801;3812155469;044583722;'  UEC IO
--'3802;3801111847;042520607;' Socsystema
select 'ORGANIZATIONID;INN;BIC;MIFAREUID;TRANSPORTCARDID;TICKETID;AMOUNT' from dual;
--REGISTERAGENTPAYMENTS 
  --SELECT '3801;3812155469;044583722;'||SUBSTR(T.CARD_CHIP,1,8)||';9643103883'||SUBSTR(T.CARD_NUM,2)||';'||LPAD(T.CARD_SERIES,4,'0')||';15000'
  SELECT '3802;3801111847;042520607;'||SUBSTR(T.CARD_CHIP,1,8)||';9643103883'||SUBSTR(T.CARD_NUM,2)||';'||LPAD(T.CARD_SERIES,4,'0')||';15000'
 FROM CPTT.T_DATA T
-- INNER JOIN CPTT.CARD C ON T.ID_CARD=C.ID
 INNER JOIN CPTT.DIVISION D ON T.ID_DIVISION=D.ID
 INNER JOIN CPTT.OPERATOR O ON D.ID_OPERATOR=O.ID  and O.ROLE=2
 --INNER JOIN CPTT.REF_JPERSON J ON O.ID_JPERSON=J.ID
 --INNER JOIN CPTT.REF_BANK B ON J.ID_BANK_ACCOUNT=B.ID
 WHERE
T.CARD_SERIES in (83) --Серии карт
 and O.CODE =10
AND   T.KIND in (7,12)
AND T.DATE_TO=TO_DATE('30.06.2016 00:00:00','DD.MM.YYYY HH24:MI:SS')

--exclude not used card
AND T.CARD_NUM  not in (
'0003003972',
'0003005048',
'0003022339',
'0003014876',
'0003005901',
'0003016935',
'0003024063',
'0003003896',
'0003023762',
'0003007187',
'0003002744',
'0003023538',
'0003003327',
'0003025195',
'0003016923',
'0003007314',
'0003014351',
'0003022308',
'0003002927',
'0003019333',
'0003013115',
'0003019097',
'0003004362',
'0003003179',
'0003006015',
'0003014960',
'0003006355',
'0003003092',
'0003005049',
'0003016168',
'0003018309',
'0003000351',
'0003013590',
'0003009313',
'0003006425',
'0003014658',
'0003017970',
'0003011320',
'0003003796',
'0003012672',
'0003015512',
'0003024115',
'0003014959',
'0003025165',
'0003019827',
'0003014767',
'0003021963',
'0003014332',
'0003007315',
'0003016455',
'0003007649',
'0003015544',
'0003023757',
'0003022112',
'0003009223',
'0003016414',
'0003009684',
'0003012632',
'0003017490',
'0003014085',
'0003008885',
'0003005091',
'0003026162',
'0003017965',
'0003013748',
'0003006765',
'0003024816',
'0003013797',
'0003014262',
'0003022927',
'0003017744',
'0003016454',
'0003018476',
'0003009295',
'0003023621',
'0003007421',
'0003006576',
'0003022866',
'0003013214',
'0003015584',
'0003017196',
'0003018418',
'0003001308',
'0003013137',
'0003009717',
'0003012531',
'0003007028',
'0003014858',
'0003022681',
'0003007890',
'0003025625',
'0003012008',
'0003020681',
'0003013284',
'0003007043',
'0003024335',
'0003004659',
'0003001591',
'0003011232',
'0003021003',
'0003024715',
'0003016646',
'0003024431',
'0003024306',
'0003023128',
'0003016944',
'0003021987',
'0003005286',
'0003001824',
'0003024353',
'0003014859',
'0003020162',
'0003025656',
'0003009794',
'0003005332',
'0003015115',
'0003004481',
'0003009316',
'0003012648',
'0003019670',
'0003001500',
'0003017986',
'0003024952',
'0003022919',
'0003020870',
'0003018447',
'0003014711',
'0003011214',
'0003012443',
'0003019751',
'0003016293',
'0003024811',
'0003015643',
'0003011735',
'0003004388',
'0003025750',
'0003003726',
'0003016467',
'0003025402',
'0003011005',
'0003018905',
'0003014791',
'0003017350',
'0003004474',
'0003001862',
'0003003238',
'0003005170',
'0003021571',
'0003000905',
'0003022834',
'0003004955',
'0003026177',
'0003022624',
'0003001235',
'0003003614',
'0003000684',
'0003006042',
'0003006202',
'0003009133',
'0003006198',
'0003017766',
'0003017440',
'0003000170',
'0003002424',
'0003006199',
'0003010577',
'0003006262',
'0003003889',
'0003013142',
'0003012184',
'0003019452',
'0003003000',
'0003017327',
'0003013343',
'0003015540',
'0003013238',
'0003004256',
'0003015378',
'0003022498',
'0003014457',
'0003011949',
'0003001847',
'0003022749',
'0003023724',
'0003016066',
'0003013746',
'0003015897',
'0003003048',
'0003016851',
'0003009693',
'0003019324',
'0003022957',
'0003006203',
'0003009774',
'0003004964',
'0003004077',
'0003026408',
'0003021318',
'0003002978',
'0003023032',
'0003002710',
'0003021564',
'0003024977',
'0003011897',
'0003022805',
'0003020109',
'0003021590',
'0003025897',
'0003023277',
'0003002074',
'0003024871',
'0003003798',
'0003014634',
'0003016694',
'0003019458',
'0003005928',
'0003008057',
'0003017144',
'0003023311',
'0003025548',
'0003022051',
'0003021466',
'0003024440',
'0003009442',
'0003025118',
'0003004439',
'0003015483',
'0003022824',
'0003001588',
'0003008231',
'0003009372',
'0003012147',
'0003006439',
'0003004989',
'0003011644',
'0003010661',
'0003014040',
'0003001764',
'0003011239',
'0003002566',
'0003013495',
'0003002497',
'0003001870',
'0003008368',
'0003003438',
'0003014828',
'0003010352',
'0003025764',
'0003000530',
'0003001792',
'0003002777',
'0003021693',
'0003002286',
'0003006635',
'0003003373',
'0003006916',
'0003002699',
'0003025419',
'0003009517',
'0003006684',
'0003023248',
'0003009754',
'0003007244',
'0003024363',
'0003021339',
'0003021348',
'0003001918',
'0003010474',
'0003025168',
'0003008155',
'0003025611',
'0003004166',
'0003020449',
'0003022322',
'0003006366',
'0003014759',
'0003001940',
'0003000352',
'0003018375',
'0003014254',
'0003004330',
'0003012573',
'0003003108',
'0003009329',
'0003001697',
'0003015013',
'0003025749',
'0003019035',
'0003002491',
'0003008547',
'0003025082',
'0003010295',
'0003009239',
'0003005458',
'0003003942',
'0003000461',
'0003002709',
'0003002489',
'0003024257',
'0003018486',
'0003023307',
'0003017907',
'0003020029',
'0003019626',
'0003014328',
'0003003381',
'0003005358',
'0003003531',
'0003011759',
'0003001668',
'0003012649',
'0003008725',
'0003016722',
'0003017567',
'0003000453',
'0003025937',
'0003013582',
'0003019753',
'0003004734',
'0003008518',
'0003019140',
'0003005258',
'0003021026',
'0003009284',
'0003013815',
'0003006749'
)

--double refillment
and T.ID not in (
17444519000001000,
17508850800001000,
17508797200001000,
17508675100001000,
17564413600001000,
17472060500001000,
17469926600001000,
17479703000001000,
17508841400001000,
17555666800001000,
17565458200001000,
17518104000001000,
17499665900001000,
17564104300001000,
17479226900001000,
17509476800001000,
17508839900001000,
17443994600001000,
17445799800001000,
17559584200001000,
17564099100001000,
17508841800001000,
17463287000001000,
17555251600001000,
17527142700001000,
17452583400001000,
17565454800001000,
17537378200001000,
17452510400001000,
17555442000001000,
17550016400001000,
17508863700001000,
17545296500001000,
17566328700001000,
17543804600001000,
17556251300001000,
17555162000001000,
17557555700001000,
17632730800001000,
17555398600001000,
17479122000001000,
17573872900001000
)


--select 'ORGANIZATIONID;INN;BIC;MIFAREUID;TRANSPORTCARDID;TICKETID;AMOUNT' from dual
--UNION
--
SELECT 
--'3801;3812155469;044583722;'||SUBSTR(MAX(T.CARD_CHIP),1,8)||';964310380'||T.CARD_NUM||';'||LPAD(MAX(T.CARD_SERIES),4,'0')||';15000' as NUM
 --,SUBSTR(MAX(T.CARD_CHIP),1,8) as CHIP1, T.CARD_NUM
--, O.CODE
-- , count (*) as kol_t
--T.*
--T.card_num, T.date_to, T.amount, T.amount_bail, T.amount_discount
T.date_to, count(*) as kol, SUM(T.amount) as s
 FROM CPTT.T_DATA T
    INNER JOIN CPTT.DIVISION D ON T.ID_DIVISION=D.ID
   INNER JOIN CPTT.OPERATOR O ON D.ID_OPERATOR=O.ID  and O.ROLE=2
 WHERE 
     --T.CARD_SERIES  in (60,63) 
     T.CARD_SERIES =83
     --and O.CODE in ('0002','0003','0004','0005','0006','0007','0008','0009','0011','0012','0013','0014','0015','0016','0017','0018','0019','0020','0021','0022','0023','0024','0025','0026','0027','0062')  
     and O.CODE = '0010'
AND   T.KIND  in (7,12)
GROUP by T.DATE_TO
--GROUP BY '964310380'||T.CARD_NUM --, O.CODE
--ORDER BY  '964310380'||T.CARD_NUM --, O.CODE
--GROUP BY T.CARD_NUM --, O.CODE
--ORDER BY T.CARD_NUM --, O.CODE

select T1.card_num, T1.amount, T1.ID, T1.DATE_OF,T1.DATE_TO, T1.INS_DATE, T1.UPD_DATE, T1.CARD_CHIP FROM CPTT.T_DATA T1 where T1.CARD_NUM in (
SELECT 
T.card_num
--, T.amount, O.CODE, O.NAME, T.ID, T.DATE_OF,T.DATE_TO, T.INS_DATE, T.UPD_DATE, T.CARD_CHIP
, count(*) as kol, SUM(T.amount) as s, MIN(T.ID)
--T.date_to, count(*) as kol, SUM(T.amount) as s
 FROM CPTT.T_DATA T
    INNER JOIN CPTT.DIVISION D ON T.ID_DIVISION=D.ID
    INNER JOIN CPTT.OPERATOR O ON D.ID_OPERATOR=O.ID  and O.ROLE=2
 WHERE 
     --T.CARD_SERIES  in (60,63) 
     T.CARD_SERIES =83
     --and O.CODE in ('0002','0003','0004','0005','0006','0007','0008','0009','0011','0012','0013','0014','0015','0016','0017','0018','0019','0020','0021','0022','0023','0024','0025','0026','0027','0062')  
     and O.CODE='0010'
AND   T.KIND  in (7,8,11,12,13)
AND T.DATE_TO=TO_DATE('30.06.2016 00:00:00','DD.MM.YYYY HH24:MI:SS')
GROUP by T.CARD_NUM
HAVING count(*)>1
)  and T1.KIND  in (7,8,11,12,13)
AND T1.DATE_TO=TO_DATE('30.06.2016 00:00:00','DD.MM.YYYY HH24:MI:SS')
ORDER BY  T1.card_num, T1.DATE_OF


