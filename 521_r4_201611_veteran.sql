--r4 - veteran
SELECT R.NUM, R.CARRIER, SUM(R.TRIP_kol) as TRIP_count, MAX(R.TARIF) as TARIF, R.VID from (
SELECT SUBSTR(T.CARD_NUM,2) as NUM, O.CODE as CARRIER, 1 as TRIP_kol
--,T.AMOUNT AS TARIF
--,16 as TARIF
, decode(R.ID_CODE_MSG,200001000,0,16) as TARIF
, decode(R.ID_CODE_MSG,200001000,1,0) as VID
--, T.*
, row_number() over (PARTITION by T.CARD_NUM ORDER BY T.DATE_OF) N
 FROM CPTT.T_DATA T
    INNER JOIN CPTT.DIVISION D ON T.ID_DIVISION=D.ID
    INNER JOIN CPTT.OPERATOR O ON D.ID_OPERATOR=O.ID  and O.ROLE=1
    INNER JOIN CPTT.ROUTE R ON T.id_route=R.ID AND T.id_division = R.id_division
 WHERE 
     nvl(T.NEW_CARD_SERIES, T.CARD_SERIES)  in (67)  
AND   T.KIND=17 
AND TO_CHAR(TRUNC(T.DATE_OF,'MM'), 'DDMMYYYY') = '01112016'
AND T.INS_DATE < TO_DATE('05.12.2016 9:11:15','DD.MM.YYYY HH24:MI:SS') --close
--exclude >30
and T.ID not in (0)
--exclude STOLLEN CARD
AND t.card_num NOT IN (
'0200300883', 
'0200404780'
) 
--AND T.INS_DATE < TO_DATE('02.11.2016  10:45:00','DD.MM.YYYY HH24:MI:SS') 
--AND T.INS_DATE < TO_DATE('02.08.2016  05:45:00','DD.MM.YYYY HH24:MI:SS')
--and T.CARD_NUM  not in ('0003027271', '0003024299')
--and  decode(R.ID_CODE_MSG,200001000,1,0) = 0 -- 0-городские, 1-пригород
)R WHERE R.N<=30
GROUP BY R.NUM, R.CARRIER,  R.VID 
ORDER BY R.VID, R.CARRIER,  R.NUM


