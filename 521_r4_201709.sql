--r4
SELECT SUBSTR(T.CARD_NUM,2) as NUM, O.CODE as CARRIER, count (*) as TRIP_COUNT
--,T.AMOUNT AS TARIF
,0 as TARIF
--, MAX(decode(R.ID_CODE_MSG,200001000,0,20)) as TARIF
, decode(R.ID_CODE_MSG,200001000,1,0) as VID
--, T.*
 FROM CPTT.T_DATA T
    INNER JOIN CPTT.DIVISION D ON T.ID_DIVISION=D.ID
    INNER JOIN CPTT.OPERATOR O ON D.ID_OPERATOR=O.ID  and O.ROLE=1
    INNER JOIN CPTT.ROUTE R ON T.id_route=R.ID AND T.id_division = R.id_division
 WHERE 
     nvl(T.NEW_CARD_SERIES, T.CARD_SERIES)  in (80,82,83)  
AND   T.KIND=17 
AND TO_CHAR(TRUNC(T.DATE_OF,'MM'), 'DDMMYYYY') = '01092017'
AND T.INS_DATE < TO_DATE('03.10.2017 12:36:14','DD.MM.YYYY HH24:MI:SS') --врем€ "закрыти€" мес€ца
and T.ID not in (0)
--exclude STOLLEN CARD
AND t.card_num NOT IN (
 '0003024684' --test card
) 
--and  decode(R.ID_CODE_MSG,200001000,1,0) = 0 -- 0-городские, 1-пригород
GROUP BY SUBSTR(T.CARD_NUM,2), O.CODE,  decode(R.ID_CODE_MSG,200001000,1,0) 
ORDER BY decode(R.ID_CODE_MSG,200001000,1,0),O.CODE, SUBSTR(T.CARD_NUM,2) 


--r4  - irk
SELECT R.NUM, R.CARRIER, SUM(R.TRIP_kol) as TRIP_count, MAX(R.TARIF) as TARIF, R.VID from (
SELECT SUBSTR(T.CARD_NUM,2) as NUM, decode(O.CODE,'0030','0030','0031') as CARRIER, 1 as TRIP_kol
--,T.AMOUNT AS TARIF
,0 as TARIF
--, decode(R.ID_CODE_MSG,200001000,0,16) as TARIF
, decode(R.ID_CODE_MSG,200001000,1,0) as VID
--, T.*
, row_number() over (PARTITION by T.CARD_NUM ORDER BY T.DATE_OF) N
 FROM CPTT.T_DATA T
    INNER JOIN CPTT.DIVISION D ON T.ID_DIVISION=D.ID
    INNER JOIN CPTT.OPERATOR O ON D.ID_OPERATOR=O.ID  and O.ROLE=1
    INNER JOIN CPTT.ROUTE R ON T.id_route=R.ID AND T.id_division = R.id_division
 WHERE 
     nvl(T.NEW_CARD_SERIES, T.CARD_SERIES)  in (84)  
AND   T.KIND=17 
AND TO_CHAR(TRUNC(T.DATE_OF,'MM'), 'DDMMYYYY') = '01092017'
AND T.INS_DATE < TO_DATE('03.10.2017 12:36:14','DD.MM.YYYY HH24:MI:SS') --close month

and T.ID not in (0)
--exclude STOLLEN CARD
AND t.card_num NOT IN (
 '0003024684' --test card 
) 
)R WHERE R.N<=30
GROUP BY R.NUM, R.CARRIER,  R.VID 
ORDER BY R.VID, R.CARRIER,  R.NUM

--kirensk
--r4


/*
--kontrol data
SELECT count(*) as tickets, SUM(kol_t) as TRIPS, MIN(minins), MAX(maxins), MAX(sysdate) FROM (
SELECT T.CARD_NUM, count (*) as kol_t, MIN(T.INS_DATE) as minins, MAX(T.INS_DATE) as maxins
 FROM CPTT.T_DATA T
    INNER JOIN CPTT.DIVISION D ON T.ID_DIVISION=D.ID
    INNER JOIN CPTT.OPERATOR O ON D.ID_OPERATOR=O.ID  and O.ROLE=1
 WHERE 
    nvl(T.NEW_CARD_SERIES, T.CARD_SERIES)  in (80,82,83,84) --+67,84  from may, -67 from 201707
     --and O.CODE in ('0002','0003','0004','0005','0006','0007','0008','0009','0011','0012','0013','0014'
    --                ,'0015','0016','0017','0018','0019','0020','0021','0022','0023','0024','0025','0026','0027','0028','0062'
--                    ,'0080'--Usolie
         --           ) 
--and   O.CODE !='0080'
AND   T.KIND=17 
AND TO_CHAR(TRUNC(T.DATE_OF,'MM'), 'DDMMYYYY') = '01092017'
AND T.INS_DATE < TO_DATE('03.10.2017 12:36:14','DD.MM.YYYY HH24:MI:SS') --врем€ "закрыти€" мес€ца
AND t.card_num NOT IN (
'0003024684' --test card
) 
GROUP BY T.CARD_NUM 
)
*/
--201709****************************************************
--37340   1067512 1-сен-2017 7:50:16  2-окт-2017 21:59:15 (2-окт-2017 22:13:37)
--37340   1067533 01.09.2017 7:50:16  03.10.2017 0:53:02  (03.10.2017 12:36:14)

--201708****************************************************
--36047   1037626 01.08.2017 8:20:06  01.09.2017 21:42:41 (04.09.2017 8:32:56)
--36047   1037626 01.08.2017 8:20:06  01.09.2017 21:42:41 (03.09.2017 21:48:23)
--36047   1037626 01.08.2017 8:20:06  01.09.2017 21:42:41 (03.09.2017 16:33:01)

--201707*****************************************************
--
--35709   1004551 01.07.2017 8:27:00  01.08.2017 21:51:28 (02.08.2017  9:27:55)
--35701   980753  01.07.2017 8:27:00  01.08.2017 12:07:41 (01.08.2017 12:18:40)

--201706****************************
--37434   1036738 01.06.2017 8:27:26  01.07.2017 20:13:19 (03.07.2017 10:18:22)
--37434   1036738 01.06.2017 8:27:26  01.07.2017 20:13:19 (04.07.2017 8:52:20)
--37434   1036845 01.06.2017 8:27:26  04.07.2017 9:43:20  (04.07.2017 9:46:03)
--37434   1036845 01.06.2017 8:27:26  04.07.2017 9:43:20  (04.07.2017 10:03:32)
--37434   1036845 01.06.2017 8:27:26  04.07.2017 9:43:20  (04.07.2017 10:45:36)
--37434   1036845 01.06.2017 8:27:26  04.07.2017 9:43:20  (04.07.2017 11:31:39)
--37434   1036878 01.06.2017 8:27:26  04.07.2017 11:39:12 (04.07.2017 13:51:40)
--37434   1036878 01.06.2017 8:27:26  04.07.2017 11:39:12 (04.07.2017 14:07:51)


--201705****************************
--36875   1003688 1-май-2017 7:45:03  4-июн-2017 5:27:47  (05.06.2017 10:04:31)
--36875   1003680 01.05.2017 7:45:03  03.06.2017 4:58:32  (03.06.2017 9:22:24)
--36875   1003503 01.05.2017 7:45:03  01.06.2017 20:25:42 (02.06.2017 9:14:10)
--36875   1003356 01.05.2017 7:45:03  01.06.2017 9:33:55  (01.06.2017 14:07:56)

--201704*****************************
--22655   515461  01.04.2017 7:46:55  03.05.2017 05:12:05 (03.05.2017 15:50:31)
--22656   515412  01.04.2017 7:46:55  30.04.2017 23:38:19 (02.05.2017 9:41:11)

--201703*****************************
--22324   530885  01.03.2017 19:30:06 01.04.2017 21:29:55 (03.04.2017 9:41:11)

--201702*****************************
--21879   482386  01.02.2017 7:57:27  01.03.2017 21:23:30 (02.03.2017 11:20:45) (80,82,83)
--21879   482386  01.02.2017 7:57:27  01.03.2017 21:23:30 (02.03.2017 23:17:17) (80,82,83)
--21879   482386  01.02.2017 7:57:27  01.03.2017 21:23:30 (03.03.2017 10:04:07) (80,82,83)

--201701*****************************
--21046   459080  01.01.2017 12:28:01 02.02.2017 21:27:09 (03.02.2017 8:31:42) (80,82,83)
--21046   458969  01.01.2017 12:28:01 01.02.2017 21:25:09 (02.02.2017 15:02:38)(80,82,83)
--21046   458969  01.01.2017 12:28:01 01.02.2017 21:25:09 (02.02.2017 13:19:12)(80,82,83)
--21046   458969  01.01.2017 12:28:01 01.02.2017 21:25:09 (02.02.2017 11:04:29)(80,82,83) 
--21046   458643  01.01.2017 12:28:01 01.02.2017 06:05:19 (01.02.2017 13:39:05)(80,82,83)
--21046   458643  01.01.2017 12:28:01 01.02.2017 06:05:19 (01.02.2017 12:00:56) (80,82,83)
--21032   440173  01.01.2017 12:28:01 31.01.2017 16:12:52 (31.01.2017 16:24:48) (80,82,83)

--201612*****************************
--22651   519884  01.12.2016 7:05:35  03.01.2017 22:13:09 (09.01.2017 10:06:49) (80,82,83)
--22651   519884  01.12.2016 7:05:35  03.01.2017 22:13:09 (05.01.2017 22:59:09) (80,82,83)
--22651   519845  01.12.2016 7:05:35  01.01.2017 11:47:14 (03.01.2017 10:13:49) (80,82,83) 
--22651   519845  01.12.2016 7:05:35  01.01.2017 11:47:14 (02.01.2017 12:19:48) (80,82,83)
--22651   519845  01.12.2016 7:05:35  01.01.2017 11:47:14 (01.01.2017 15:16:27) (80,82,83)

--201611 *************************
--23136   517305  01.11.2016 8:18:53  03.12.2016 21:38:58 (05.12.2016 9:11:15) (80,82,83) --close month
--23136   517210  01.11.2016 8:18:53  02.12.2016 9:11:17  (02.12.2016 17:05:27) (80,82,83)
--23137   517211  01.11.2016 8:18:53  02.12.2016 9:11:17  (02.12.2016 14:37:26) (80,82,83)

--201610 *************************
--18150   422638  01.10.2016 12:30:32 31.10.2016 23:06:26
--18150   422730  1-окт-2016 12:30:32 1-но€-2016 21:41:06 (1-но€-2016 22:17:46) - 83
--23024   518807  1-окт-2016 12:30:32 1-но€-2016 21:41:06 (1-но€-2016 22:20:40) 80 82 83
--23024   518807  1-окт-2016 12:30:32 1-но€-2016 21:41:06 (1-но€-2016 22:42:41) 80 82 83
--23024   518807  01.10.2016 12:30:32 01.11.2016 21:41:06 (02.11.2016 9:26:22)  80 82 83
--23024   518807  01.10.2016 12:30:32 01.11.2016 21:41:06 (02.11.2016 10:44:15) 80 82 83
--23023   518806  01.10.2016 12:30:32 01.11.2016 21:41:06 (02.11.2016 13:36:45) 80 82 83 !!! 

--201609--
-- 17481   395198  01.09.2016 10:28:11 30.09.2016 23:13:08
-- 17482   395736  01.09.2016 10:28:11 02.10.2016 21:34:31 (20161003 9:30)
-- 17479   395743  01.09.2016 10:28:11 03.10.2016 12:21:10 (20161003 15:30)
-- 17477   395743  01.09.2016 10:28:11 03.10.2016 12:21:10 (20161003 17:47)
-- 17475   395811  01.09.2016 10:28:11 03.10.2016 17:40:33 (20161003 18:39)
-- 17475   395811  01.09.2016 10:28:11 03.10.2016 17:40:33 (20161003 22:52)
-- 17474   395808  01.09.2016 10:28:11 03.10.2016 17:40:33 (20161003 18:40) + 003027271  исключена, как не подтвержденна€ карта
---201608-------
--***************
--18218   658536  1-авг-2016 16:51:31 1-сен-2016 22:07:02 (20160905 09:18)
--18218   658536  01.08.2016 16:51:31 01.09.2016 22:07:02 (20160905 15:11)
--*******************************************
--18427 -689355 (20160302 23:13)
--18427 -689355 (20160303 08:33)
--18427 -689355 (20160309 12:27)

--march
--19962  -807001 (20160401 15:33)
--19962  -807780 (20160404 12:16)

--april 2016
--20157 840548 (20160502 16:37)
--20157 840548 (20160504 11:24)
--20157 840548 (20160518 14:12)
--20157   840548  01.04.2016 8:14:31  01.05.2016 21:06:18 (20160601 15:55)

--may 2016
--19533   747827 (20160601 15:34)
--19533   747827  01.05.2016 4:34:22  01.06.2016 6:22:58 (20160601 15:55)
--19533   748908  01.05.2016 4:34:22  01.06.2016 21:28:43(20160602 09:25)
--19533   748908  01.05.2016 4:34:22  01.06.2016 21:28:43 (20160602 17:05)
--19533   749251  1-май-2016 4:34:22  2-июн-2016 21:05:37 (20160607 10:41)!!!!!!

--june 2016
--19057   609594  01.06.2016 7:57:26  27.06.2016 10:28:47 (20160627 12:00)
--19134   690574  1-июн-2016 7:57:26  30-июн-2016 11:19:37 (20160630 12:17)
--19146   717213  1-июн-2016 7:57:26  30-июн-2016 23:08:31 (20160703 12:03)
--19146   717213  01.06.2016 7:57:26  30.06.2016 23:08:31 (20160704 07:00)
--19147   717220  01.06.2016 7:57:26  04.07.2016 9:35:10 (20160705 10:43)!!!!!!

--july 2016
-- 18577   527872  1-июл-2016 17:55:20 25-июл-2016 13:53:35 (20160725 15:50 all oper)
---18571   527866  1-июл-2016 17:55:20 25-июл-2016 13:53:35 (20160725 15:50 not in '0080')
-- 18722   687666  1-июл-2016 17:55:20 02-авг-2016 05:44:00 (20160802 12:40)
--18722    687666  01.07.2016 17:55:20 02.08.2016  05:44:00 (20160803 09:06)
--18722    687673  01.07.2016 17:55:20 04.08.2016  06:36:36 (20160804 09:23)!!!
 
