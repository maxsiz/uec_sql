/*
--Реестр пополнения кошельков, февраль 2016
select 'ORGANIZATIONID;INN;BIC;MIFAREUID;TRANSPORTCARDID;TICKETID;AMOUNT' from dual;
--REGISTERAGENTPAYMENTS 
  SELECT '3801;3812155469;044583722;'||SUBSTR(T.CARD_CHIP,1,8)||';9643103883'||SUBSTR(T.CARD_NUM,2)||';'||LPAD(T.CARD_SERIES,4,'0')||';15000'
 FROM CPTT.T_DATA T
-- INNER JOIN CPTT.CARD C ON T.ID_CARD=C.ID
 INNER JOIN CPTT.DIVISION D ON T.ID_DIVISION=D.ID
 INNER JOIN CPTT.OPERATOR O ON D.ID_OPERATOR=O.ID  and O.ROLE=2
 --INNER JOIN CPTT.REF_JPERSON J ON O.ID_JPERSON=J.ID
 --INNER JOIN CPTT.REF_BANK B ON J.ID_BANK_ACCOUNT=B.ID
 WHERE
T.CARD_SERIES in (83) --Серии карт
 and O.CODE =10
AND   T.KIND in (7,12)
AND T.DATE_TO=TO_DATE('29.02.2016 00:00:00','DD.MM.YYYY HH24:MI:SS')
--исключаем/включаем детей
AND T.CARD_NUM not in (
 003002925
,003003959
,003003989
,003006230
,003008867
,003011870
,003015211
,003001170
,003001277
,003001279
,003001953
,003002280
,003002345
,003003574
,003004850
,003004955
,003005019
,003008229
,003009911
,003011026
,003011027
,003011036
,003011447
,003012329
,003012535
,003012642
,003013785
,003013790
,003013913
,003015782
,003017200
,003017276
,003018441
,003018463
,003019481
,003017341
,003018586
,003019820
,003017460
,003018630
,003016238
,003016271
,003018811
,003020252
,003020289
,003017810
,003020361
,003016663
,003019000
,003019020
,003017949
,003019071
,003020529
,003016900
,003018151
,003018157
,003021107
,003021537
,003020027
,003021611
,003020182
,003020388
,003022575
,003021802
,003020774
,003020781
,003021961
,003022034
,003022415
,003022072
,003021235
,003021237
,003022136
,003022699
,003022994
,003023111
,003023397
,003023492
,003023804
,003023869
,003023992
,003024045
,003024320
,003024354
,003024743
,003024136
,003025382
,003025395
,003025465
,003025352
)
*/

--select 'ORGANIZATIONID;INN;BIC;MIFAREUID;TRANSPORTCARDID;TICKETID;AMOUNT' from dual
--UNION
--
SELECT 
--'3801;3812155469;044583722;'||SUBSTR(MAX(T.CARD_CHIP),1,8)||';964310380'||T.CARD_NUM||';'||LPAD(MAX(T.CARD_SERIES),4,'0')||';15000' as NUM
 --,SUBSTR(MAX(T.CARD_CHIP),1,8) as CHIP1, T.CARD_NUM
--, O.CODE
-- , count (*) as kol_t
--T.*
--T.card_num, T.date_to, T.amount, T.amount_bail, T.amount_discount
T.date_to, count(*) as kol, SUM(T.amount) as s
 FROM CPTT.T_DATA T
    INNER JOIN CPTT.DIVISION D ON T.ID_DIVISION=D.ID
   -- INNER JOIN CPTT.OPERATOR O ON D.ID_OPERATOR=O.ID  and O.ROLE=2
 WHERE 
     --T.CARD_SERIES  in (60,63) 
     T.CARD_SERIES =83
     --and O.CODE in ('0002','0003','0004','0005','0006','0007','0008','0009','0011','0012','0013','0014','0015','0016','0017','0018','0019','0020','0021','0022','0023','0024','0025','0026','0027','0062')  
AND   T.KIND  in (7,12)
GROUP by T.DATE_TO
--GROUP BY '964310380'||T.CARD_NUM --, O.CODE
--ORDER BY  '964310380'||T.CARD_NUM --, O.CODE
--GROUP BY T.CARD_NUM --, O.CODE
--ORDER BY T.CARD_NUM --, O.CODE

SELECT 
T.card_num, T.amount, O.CODE, O.NAME, T.ID, T.DATE_OF,T.DATE_TO, T.INS_DATE, T.UPD_DATE, T.CARD_CHIP
--, count(*) as kol, SUM(T.amount) as s
--T.date_to, count(*) as kol, SUM(T.amount) as s
 FROM CPTT.T_DATA T
    INNER JOIN CPTT.DIVISION D ON T.ID_DIVISION=D.ID
    INNER JOIN CPTT.OPERATOR O ON D.ID_OPERATOR=O.ID  and O.ROLE=2
 WHERE 
     --T.CARD_SERIES  in (60,63) 
     T.CARD_SERIES =83
     --and O.CODE in ('0002','0003','0004','0005','0006','0007','0008','0009','0011','0012','0013','0014','0015','0016','0017','0018','0019','0020','0021','0022','0023','0024','0025','0026','0027','0062')  
     and O.CODE='0010'
AND   T.KIND  in (7,8,11,12,13)
AND T.DATE_TO=TO_DATE('29.02.2016 00:00:00','DD.MM.YYYY HH24:MI:SS')
--GROUP by T.CARD_NUM
--HAVING count(*)>1





